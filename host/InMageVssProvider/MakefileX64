# Makefile for generating InMageVssProvider's Release and Debug Builds
# for Windows 2003.
#
# To build all Release and Debug builds, use below command
# 	nmake -f MakefileX64 All
#
# To build only Release build, use below command
# 	nmake -f MakefileX64 Release
#
# To build only Debug build, use below command
# 	nmake -f MakefileX64 Debug
#
# To Clean existing builds, use below command
# 	nmake -f MakefileX64 Clean
#
#   {X64/Release/Debug}\InMageVssProvider_X64.dll is generated for Windows 2003
#


## Specify Compiler and Linker Executables
CC=cl.exe
LINK=link.exe
RC=rc.exe
MIDL=midl.exe

# Specify HeaderFiles (.h suffix)
HEADERS=_IVacpProviderEvents_CP.h dllmain.h  resource.h stdafx.h targetver.h VacpProvider.h VacpProviderCommon.h
# Specify Source Files (.cpp suffix)
SRC=stdafx.cpp VacpProvider.cpp utility.cpp InMageVssProvider.cpp dllmain.cpp

#Specify Source Files (.c suffix)
INTER_SRC=InMageVssProvider_i.c

#Specify resource Files (.rc suffix)
RC_SOURCE=InMageVssProvider.rc

DEBUG_RCFLAGS=/d "X64" /fo X64\Debug\InMageVssProvider_X64.res /i "X64\Debug"
RELEASE_RCFLAGS=/d "X64" /fo X64\Release\InMageVssProvider_X64.res /i "X64\Release"

# Specify precompile header file
PCHFILE="stdafx.h"

# Specify Compilation Flags for Release build
RELEASE_CPPFLAGS=/O2 /D "WIN64" /D "_CONSOLE" /D "_CRT_SECURE_NO_WARNINGS" /D "_CRT_NONSTDC_NO_DEPRECATE" /D "_WIN32_WINNT=0x0502"\
                 /D "VSS_SERVER" /D "_ATL_STATIC_REGISTRY" /D "_USING_V110_SDK71_" /D "_USRDLL" /FD /EHsc /MT\
                 /W3 /nologo /c /Zc:wchar_t- /Wp64 /Zi /TP /guard:cf /Qspectre /DYNAMICBASE
                
RELEASE_CFLAGS=/O2 /D "WIN64" /D "_CONSOLE" /D "_CRT_SECURE_NO_WARNINGS" /D "_CRT_NONSTDC_NO_DEPRECATE" /D "_WIN32_WINNT=0x0502"\
                 /D "VSS_SERVER" /D "_ATL_STATIC_REGISTRY" /D "_USING_V110_SDK71_" /D "_USRDLL" /FD /EHsc /MT\
                 /W3 /nologo /c /Zc:wchar_t- /Wp64 /Zi /TC /guard:cf /Qspectre /DYNAMICBASE
                 
RELEASE_HOST_CPPFLAGS= /Fo"X64/Release/"

# Specify Compilation Flags for Debug build
DEBUG_CPPFLAGS=/Od /D "WIN64" /D "_DEBUG" /D "_CONSOLE" /D "_CRT_SECURE_NO_WARNINGS" /D "_CRT_NONSTDC_NO_DEPRECATE"\
               /D "VSS_SERVER" /Gm /EHsc /MTd\
               /D "_ATL_STATIC_REGISTRY" /D "_USING_V110_SDK71_" /D "_USRDLL" /W3 /nologo /c /Zc:wchar_t- /Wp64 /Zi /TP /guard:cf /Qspectre /DYNAMICBASE
               
DEBUG_CFLAGS=/Od /D "WIN64" /D "_DEBUG" /D "_CONSOLE" /D "_CRT_SECURE_NO_WARNINGS" /D "_CRT_NONSTDC_NO_DEPRECATE"\
               /D "VSS_SERVER"  /Gm /EHsc /MTd\
               /D "_ATL_STATIC_REGISTRY" /D "_USING_V110_SDK71_" /D "_USRDLL" /W3 /nologo /c /Zc:wchar_t- /Wp64 /Zi /TC /guard:cf /Qspectre /DYNAMICBASE
				    				    
DEBUG_HOST_CPPFLAGS= /Fo"X64/Debug/"

CUR_DIR=..\InMageVssProvider

# Specify VSS SKD Libraries
VSS_LIBS=vssapi.lib vss_uuid.lib 

#This debug flag gets enabled 
ENABLE_DEBUG=

# Specify Windows Static libraries
OS_LIBS=rpcrt4.lib kernel32.lib user32.lib gdi32.lib winspool.lib comdlg32.lib\
        advapi32.lib shell32.lib ole32.lib oleaut32.lib uuid.lib odbc32.lib\
        odbccp32.lib ws2_32.lib 

# Specify Linking flags for Release build
RELEASE_LFLAGS=/INCREMENTAL:NO /NOLOGO /SUBSYSTEM:CONSOLE,5.02 /OPT:NOREF /OPT:ICF /DYNAMICBASE /NXCOMPAT\
               /MACHINE:AMD64 /MAP /MAPINFO:EXPORTS /DEBUG /DEBUGTYPE:CV,FIXUP /guard:cf
              
               
# Specify Linking flags for Debug build
DEBUG_LFLAGS=/INCREMENTAL /NOLOGO /SUBSYSTEM:CONSOLE,5.02 /MACHINE:AMD64	/DEBUG /DYNAMICBASE /NXCOMPAT /guard:cf 
            
WIN_2K3_VERSION=/D "_WIN32_WINNT=0x502"

# Compute Include directories for Windows 2003 Build
WIN2K3_INC_DIR=/I $(CUR_DIR)) /I "..\inmsafecapis" /I "..\inmsafecapis\win" /I "..\common"

# Compute Link flags for WIndows 2003 Release Build
RELEASE_WIN2K3_LFLAGS=$(RELEASE_LFLAGS) /PDB:"X64/Release/InMageVssProvider_X64.pdb"

# Compute Link flags for WIndows 2003 Debug Build
DEBUG_WIN2K3_LFLAGS=$(DEBUG_LFLAGS) /PDB:"X64/Debug/InMageVssProvider_X64.pdb"

#Generate both FabricRelease and debug builds
all: Debug Release

#Generate Release build for Windows 2003
Release: X64\Release\vacprpc_c.obj X64\Release\InMageVssProvider_X64.dll

#Generate Debug build for Windows 2003
Debug: X64\Debug\vacprpc_c.obj X64\Debug\InMageVssProvider_X64.dll

# vacprpcs stub file
X64\Release\vacprpc_c.obj : ..\vacp\vacprpc\vacprpc.idl ..\vacp\vacprpc\vacprpc.acf
	@$(MIDL) /env x64 /Oicf /acf ..\vacp\vacprpc\vacprpc.acf ..\vacp\vacprpc\vacprpc.idl
	@$(CC) $(RELEASE_CFLAGS) $(RELEASE_HOST_CPPFLAGS) $(WIN_2K3_VERSION) $(WIN2K3_INC_DIR) vacprpc_c.c

X64\Debug\vacprpc_c.obj : ..\vacp\vacprpc\vacprpc.idl ..\vacp\vacprpc\vacprpc.acf
	@$(MIDL) /env x64 /Oicf /acf ..\vacp\vacprpc\vacprpc.acf ..\vacp\vacprpc\vacprpc.idl
	@$(CC) $(DEBUG_CFLAGS) $(DEBUG_HOST_CPPFLAGS) $(WIN_2K3_VERSION) $(WIN2K3_INC_DIR) vacprpc_c.c


X64\Release\InMageVssProvider_X64.dll: $(HEADERS) $(SRC) MakefileX64
	@echo -------------------------------------------------------------
	@echo Generating Windows 2003 Release build(X64\Release\InMageVssProvider_X64.dll)...
	@echo -------------------------------------------------------------
	@IF NOT EXIST X64\Release MD X64\Release
	@$(MIDL) InMageVssProvider.idl /D "NDEBUG" /nologo /char signed /env x64 /Oicf /tlb "X64\Release\InMageVssProvider.tlb" /h "InMageVssProvider_i.h" /iid "InMageVssProvider_i.c" /proxy "InMageVssProvider_p.c" /error stub_data
	@$(CC) $(RELEASE_CPPFLAGS) $(RELEASE_HOST_CPPFLAGS) $(WIN_2K3_VERSION) $(WIN2K3_INC_DIR) $(SRC)
	@$(CC) $(RELEASE_CFLAGS) $(RELEASE_HOST_CPPFLAGS) $(WIN_2K3_VERSION) $(WIN2K3_INC_DIR) $(INTER_SRC)
	@$(RC) $(RELEASE_RCFLAGS) /d "InMageVssProvider_X64_DLL" $(RC_SOURCE)
	@$(LINK) $(RELEASE_WIN2K3_LFLAGS) /DEF:InMageVssProvider_X64.def /DLL /implib:X64\Release\InMageVssProvider_X64.lib /OUT:X64\Release\InMageVssProvider_X64.dll X64\Release\*.obj X64\Release\*.res $(VSS_LIBS) $(OS_LIBS)

#Generate Debug build for Windows 2003
X64\Debug\InMageVssProvider_X64.dll: $(HEADERS) $(SRC) MakefileX64
	@echo ---------------------------------------------------------
	@echo Generating Windows 2003 Debug build(X64\Debug\InMageVssProvider_X64.dll)...
	@echo ---------------------------------------------------------
	@IF NOT EXIST X64\Debug MD X64\Debug
	@$(MIDL) InMageVssProvider.idl /D "_DEBUG" /nologo /char signed /env x64 /Oicf /tlb "X64\Debug\InMageVssProvider.tlb" /h "InMageVssProvider_i.h" /iid "InMageVssProvider_i.c" /proxy "InMageVssProvider_p.c" /error stub_data
	@$(CC) $(DEBUG_CPPFLAGS) $(DEBUG_HOST_CPPFLAGS) $(WIN_2K3_VERSION) $(WIN2K3_INC_DIR) $(SRC)
	@$(CC) $(DEBUG_CFLAGS) $(DEBUG_HOST_CPPFLAGS) $(WIN_2K3_VERSION) $(WIN2K3_INC_DIR) $(INTER_SRC)
	@$(RC) $(DEBUG_RCFLAGS) /d "InMageVssProvider_X64_DLL" $(RC_SOURCE)
	@$(LINK) $(DEBUG_WIN2K3_LFLAGS) /DEF:InMageVssProvider_X64.def /DLL /implib:X64\Debug\InMageVssProvider_X64.lib /OUT:X64\Debug\InMageVssProvider_X64.dll X64\Debug\*.obj X64\Debug\*.res $(VSS_LIBS) $(OS_LIBS)

#Clean both Release and Debug builds
clean:	
	@echo ----------------------------------------------------
	@echo Cleaning Windows 2003 X64 Release,Debug builds...
	@echo ----------------------------------------------------
	@IF EXIST X64\Release DEL /Q X64\Release\*.*
	@IF EXIST X64\Debug DEL /Q X64\Debug\*.*
	DEL vacprpc*.*

#Clean both Release build only
clean_release:
	@echo ----------------------------------------------------
	@echo Cleaning Windows 2003 X64 Release build...
	@echo ----------------------------------------------------
	@IF EXIST X64\Release DEL /Q X64\Release\*.*
	DEL vacprpc*.*

#Clean Debug build only
clean_debug:
	@echo ----------------------------------------------------
	@echo Cleaning Windows 2003 X64 Debug build...
	@echo ----------------------------------------------------
	@IF EXIST X64\Debug DEL /Q X64\Debug\*.*
	DEL vacprpc*.*
