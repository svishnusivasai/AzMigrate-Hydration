# Makefile for generating InMageVssProvider's Release and Debug Builds
# for Windows 2003.
#
# To build all Release and Debug builds, use below command
# 	nmake -f MakefileIA64 All
#
# To build only Release build, use below command
# 	nmake -f MakefileIA64 Release
#
# To build only Debug build, use below command
# 	nmake -f MakefileIA64 Debug
#
# To Clean existing builds, use below command
# 	nmake -f MakefileIA64 Clean
#
#   {IA64/Release/Debug}\InMageVssProvider_IA64.dll is generated for Windows 2003
#


## Specify Compiler and Linker Executables
CC=cl.exe
LINK=link.exe
RC=rc.exe
MIDL=midl.exe

# Specify HeaderFiles (.h suffix)
HEADERS=_IVacpProviderEvents_CP.h dllmain.h  resource.h stdafx.h targetver.h VacpProvider.h

# Specify Source Files (.cpp suffix)
SRC=stdafx.cpp VacpProvider.cpp utility.cpp InMageVssProvider.cpp dllmain.cpp

#Specify Source Files (.c suffix)
INTER_SRC=InMageVssProvider_i.c

#Specify resource Files (.rc suffix)
RC_SOURCE=InMageVssProvider.rc

DEBUG_RCFLAGS=/d "IA64" /fo IA64\Debug\InMageVssProvider_IA64.res /i "IA64\Debug"
RELEASE_RCFLAGS=/d "IA64" /fo IA64\Release\InMageVssProvider_IA64.res /i "IA64\Release"

# Specify precompile header file
PCHFILE="stdafx.h"

# Specify Compilation Flags for Release build
RELEASE_CPPFLAGS=/O2 /Od /D "WIN64" /D "_CONSOLE" /D "_CRT_SECURE_NO_WARNINGS" /D "_CRT_NONSTDC_NO_DEPRECATE" /D "_WIN32_WINNT=0x0502"\
                 /D "VSS_SERVER" /D "_ATL_STATIC_REGISTRY" /D "_USING_V110_SDK71_" /D "_USRDLL" /FD /EHsc /MT\
                 /W3 /nologo /c /Zc:wchar_t- /Wp64 /Zi /TP /guard:cf /Qspectre /DYNAMICBASE

RELEASE_CFLAGS=/O2 /D "WIN64" /D "_CONSOLE" /D "_CRT_SECURE_NO_WARNINGS" /D "_CRT_NONSTDC_NO_DEPRECATE" /D "_WIN32_WINNT=0x0502"\
                 /D "VSS_SERVER" /D "_ATL_STATIC_REGISTRY" /D "_USING_V110_SDK71_" /D "_USRDLL" /FD /EHsc /MT\
                 /W3 /nologo /c /Zc:wchar_t- /Wp64 /Zi /TC /guard:cf /Qspectre /DYNAMICBASE
RELEASE_HOST_CPPFLAGS= /Fo"IA64/Release/"

# Specify Compilation Flags for Debug build
DEBUG_CPPFLAGS=/Od /D "WIN64" /D "_DEBUG" /D "_CONSOLE" /D "_CRT_SECURE_NO_WARNINGS" /D "_CRT_NONSTDC_NO_DEPRECATE"\
               /D "VSS_SERVER"  /D "_USING_V110_SDK71_" /D "_USRDLL" /Gm /EHsc /MTd\
               /D "_ATL_STATIC_REGISTRY" /W3 /nologo /c /Zc:wchar_t- /Wp64 /Zi /TP /guard:cf /Qspectre /DYNAMICBASE

DEBUG_CFLAGS=/Od /D "WIN64" /D "_DEBUG" /D "_CONSOLE" /D "_CRT_SECURE_NO_WARNINGS" /D "_CRT_NONSTDC_NO_DEPRECATE"\
               /D "VSS_SERVER" /D "_USING_V110_SDK71_" /D "_USRDLL" /Gm /EHsc /MTd\
               /D "_ATL_STATIC_REGISTRY" /W3 /nologo /c /Zc:wchar_t- /Wp64 /Zi /TC /guard:cf /Qspectre /DYNAMICBASE
				    
DEBUG_HOST_CPPFLAGS= /Fo"IA64/Debug/"

# Specify VSS SDK's Include and Library paths
#VSS_INC_DIR="..\..\thirdparty\vss\inc"
#VSS_INC_DIR="C:\Program Files\Microsoft\VSSSDK72\inc"
#VSS_LIB_DIR="..\..\thirdparty\vss\lib"
#VSS_LIB_DIR="C:\Program Files\Microsoft\VSSSDK72\lib"
CUR_DIR=..\InMageVssProvider

# Specify VSS SKD Libraries
VSS_LIBS=vssapi.lib vss_uuid.lib 

#This debug flag gets enabled 
ENABLE_DEBUG=

# Specify Debug Thirdparty Libraries
#THIRDPARTY_DEBUG_LIBS=curlib.lib libssl.lib libcrypto.lib zlib.lib ACEsd.lib

# Specify FabricRelease Thirdparty Libraries
#THIRDPARTY_RELEASE_LIBS=curlib.lib libssl.lib libcrypto.lib zlib.lib ACEs.lib

# Specify Windows Static libraries
OS_LIBS=rpcrt4.lib kernel32.lib user32.lib gdi32.lib winspool.lib comdlg32.lib\
        advapi32.lib shell32.lib ole32.lib oleaut32.lib uuid.lib odbc32.lib\
        odbccp32.lib ws2_32.lib WinInet.lib

# Specify Linking flags for Release build
RELEASE_LFLAGS=/INCREMENTAL:NO /NOLOGO /SUBSYSTEM:CONSOLE,5.02 /OPT:NOREF /OPT:ICF /DYNAMICBASE /NXCOMPAT\
               /MACHINE:IA64 /MAP /MAPINFO:EXPORTS /DEBUG /guard:cf
               
# Specify Linking flags for Debug build
DEBUG_LFLAGS=/INCREMENTAL /NOLOGO /SUBSYSTEM:CONSOLE,5.02 /MACHINE:IA64	/DEBUG /DYNAMICBASE /NXCOMPAT /guard:cf
		           


WIN_2K3_VERSION=/D "_WIN32_WINNT=0x502"

# Compute Include directories for Windows 2003 Build
WIN2K3_INC_DIR=/I $(CUR_DIR)) /I$(VSS_INC_DIR)\win2003 /I "..\inmsafecapis" /I "..\inmsafecapis\win" /I "..\common"

# Compute Link flags for WIndows 2003 Release Build
RELEASE_WIN2K3_LFLAGS=$(RELEASE_LFLAGS) /PDB:"IA64/Release/InMageVssProvider_IA64.pdb"

# Compute Link flags for WIndows 2003 Debug Build
DEBUG_WIN2K3_LFLAGS=$(DEBUG_LFLAGS) /PDB:"IA64/Debug/InMageVssProvider_IA64.pdb"

#Generate both FabricRelease and debug builds
all: Debug Release

#Generate Release build for Windows 2003
Release: IA64\release\InMageVssProvider_IA64.dll

#Generate Debug build for Windows 2003
Debug: IA64\debug\InMageVssProvider_IA64.dll 

#Generate Release build for Windows 2003
#removed the following lines
#@$(CC) $(RELEASE_CPPFLAGS) $(RELEASE_HOST_CPPFLAGS) $(WIN_2K3_VERSION) /Yc$(PCHFILE) $(WIN2K3_INC_DIR) $(SRC)
#@$(CC) $(RELEASE_CPPFLAGS) $(RELEASE_HOST_CPPFLAGS) $(WIN_2K3_VERSION) /Yu$(PCHFILE) $(WIN2K3_INC_DIR) $(SRC)


IA64\release\InMageVssProvider_IA64.dll: $(HEADERS) $(SRC) MakefileIA64
	@echo -------------------------------------------------------------
	@echo Generating Windows 2003 Release build(IA64\Release\InMageVssProvider_IA64.dll)...
	@echo -------------------------------------------------------------
	@IF NOT EXIST IA64\Release MD IA64\Release
	@$(MIDL) InMageVssProvider.idl /D "NDEBUG" /nologo /char signed /env ia64 /Oicf /tlb "IA64\Release\InMageVssProvider.tlb" /h "InMageVssProvider_i.h" /iid "InMageVssProvider_i.c" /proxy "InMageVssProvider_p.c" /error stub_data
	@$(CC) $(RELEASE_CPPFLAGS) $(RELEASE_HOST_CPPFLAGS) $(WIN_2K3_VERSION) $(WIN2K3_INC_DIR) $(SRC)
	@$(CC) $(RELEASE_CFLAGS) $(RELEASE_HOST_CPPFLAGS) $(WIN_2K3_VERSION) $(WIN2K3_INC_DIR) $(INTER_SRC)
	@$(RC) $(RELEASE_RCFLAGS) /d "InMageVssProvider_IA64_DLL" $(RC_SOURCE)
	@$(LINK) $(RELEASE_WIN2K3_LFLAGS) /DEF:InMageVssProvider_IA64.def /DLL /implib:IA64\Release\InMageVssProvider_IA64.lib /OUT:IA64\Release\InMageVssProvider_IA64.dll IA64\Release\*.obj IA64\Release\*.res $(VSS_LIBS) $(OS_LIBS)

#Generate Debug build for Windows 2003
IA64\Debug\InMageVssProvider_IA64.dll: $(HEADERS) $(SRC) MakefileIA64
	@echo ---------------------------------------------------------
	@echo Generating Windows 2003 Debug build(IA64\Debug\InMageVssProvider_IA64.dll)...
	@echo ---------------------------------------------------------
	@IF NOT EXIST IA64\Debug MD IA64\Debug
	@$(MIDL) InMageVssProvider.idl /D "_DEBUG" /nologo /char signed /env ia64 /Oicf /tlb "IA64\Debug\InMageVssProvider.tlb" /h "InMageVssProvider_i.h" /iid "InMageVssProvider_i.c" /proxy "InMageVssProvider_p.c" /error stub_data
	@$(CC) $(DEBUG_CPPFLAGS) $(DEBUG_HOST_CPPFLAGS) $(WIN_2K3_VERSION) $(WIN2K3_INC_DIR) $(SRC)
	@$(CC) $(DEBUG_CFLAGS) $(DEBUG_HOST_CPPFLAGS) $(WIN_2K3_VERSION) $(WIN2K3_INC_DIR) $(INTER_SRC)
	@$(RC) $(DEBUG_RCFLAGS) /d "InMageVssProvider_IA64_DLL" $(RC_SOURCE)
	@$(LINK) $(DEBUG_WIN2K3_LFLAGS) /DEF:InMageVssProvider_IA64.def /DLL /implib:ia64\Debug\InMageVssProvider_IA64.lib /OUT:IA64\Debug\InMageVssProvider_IA64.dll IA64\Debug\*.obj IA64\Debug\*.res $(VSS_LIBS) $(OS_LIBS)





#Clean both Release and Debug builds
clean:	
	@echo ----------------------------------------------------
	@echo Cleaning Windows 2003 IA64 Release,Debug builds...
	@echo ----------------------------------------------------
	@IF EXIST IA64\Release DEL /Q IA64\Release\*.*
	@IF EXIST IA64\Debug DEL /Q IA64\Debug\*.*

#Clean both Release build only
clean_release:
	@echo ----------------------------------------------------
	@echo Cleaning Windows 2003 IA64 Release build...
	@echo ----------------------------------------------------
	@IF EXIST IA64\Release DEL /Q IA64\Release\*.*

#Clean Debug build only
clean_debug:
	@echo ----------------------------------------------------
	@echo Cleaning Windows 2003 IA64  Debug build...
	@echo ----------------------------------------------------
	@IF EXIST IA64\Debug DEL /Q IA64\Debug\*.*

